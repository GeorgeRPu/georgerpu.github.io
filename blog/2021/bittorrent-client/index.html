<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Implementing a BitTorrent-like P2P File Sharing Protocol | George Pu</title> <meta name="author" content="George Pu"> <meta name="description" content="A lesson in software design"> <meta name="keywords" content="academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%A7%AE&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://georgerpu.github.io/blog/2021/bittorrent-client/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">George </span>Pu</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Implementing a BitTorrent-like P2P File Sharing Protocol</h1> <p class="post-meta">January 10, 2021</p> <p class="post-tags"> <a href="/blog/2021"> <i class="fas fa-calendar fa-sm"></i> 2021 </a>   ·   <a href="/blog/tag/computer-science"> <i class="fas fa-hashtag fa-sm"></i> computer-science</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>A common project in computer networking classes is implementing the peer-to-peer (P2P) file transfer protocol BitTorrent<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. Like many students, the design was hastily conceived and the code shabbily written. After all, I just needed to produce a working implementation, which would never be revisited. However, I thought it would be an instructive exercise to rewrite my project code, seeing where I went wrong and what could be done to fix it. The GitHub repo containing all 3 implementations is <a href="https://github.com/GeorgeRPu/BitTorrent-like" rel="external nofollow noopener" target="_blank">https://github.com/GeorgeRPu/BitTorrent-like</a>. Snippets will be reproduced here. For the sake of brevity, the implementation for many functions are omitted along with import statements.</p> <h2 id="bittorrent-specification">BitTorrent Specification</h2> <p>BitTorrent works by dividing a file into indexed fixed size pieces which are then distributed across a <strong>torrent</strong>, a group of hosts or <strong>peers</strong> exchanging pieces. A peer’s <strong>neighbors</strong> are the subset of a torrent it connects to. A <strong>tracker</strong> tracks the peers in a torrent. New peers joining a torrent register with the tracker and get a list of participating peers. After registering, peers open a TCP connection with some peers in the torrent. Once the opposing peers accept the connection, the BitTorrent protocol begins.</p> <p>The connecting peer sends a handshake message.</p> <ul> <li>It starts with 19 followed by “BitTorrent protocol”. The 19 is a length prefix.</li> <li>After this header are 8 reserved bytes of 0’s. The remaining data are big-endian 32 bit integers.</li> <li>Next is the 20 byte SHA1 hash of the info value (obtained from the tracker). If both peers in a connection don’t transmit the same hash, the connection is closed.</li> <li>Last is the 20 byte peer ID.</li> </ul> <p>Once both sides handshake, they begin sending regular messages. Their format is a 4-byte length not including itself, a 1-byte type, and a variable length payload. The file sharing protocol is tit-for-tat: the peers sending the most pieces are unchoked, while the remaining neighbors are choked (no pieces transferred). In addition to these, a random neighbor is optimistically unchoked periodically.</p> <table> <thead> <tr> <th>Message</th> <th>Payload</th> <th>When sent</th> </tr> </thead> <tbody> <tr> <td>0 - choke</td> <td> </td> <td>Periodically</td> </tr> <tr> <td>1 - unchoke</td> <td> </td> <td>Periodically</td> </tr> <tr> <td>2 - interested</td> <td> </td> <td>In response to have/bitfield if peer</td> </tr> <tr> <td>3 - not interested</td> <td> </td> <td>Same as interested</td> </tr> <tr> <td>4 - have</td> <td>32 bit index of piece just downloaded</td> <td>To neighbors after downloading piece</td> </tr> <tr> <td>5 - bitfield</td> <td>Bitarray of pieces the peer possesses</td> <td>As first message</td> </tr> <tr> <td>6 - request</td> <td>32 bit index of desired piece, begin and length offsets</td> <td>In response to unchoke or piece</td> </tr> <tr> <td>7 - piece</td> <td>32 bit index of piece just sent, file piece</td> <td>In response to request; may be pipelined</td> </tr> <tr> <td>8 - cancel</td> <td>same as request</td> <td>If downloading same piece from multiple peers, cancel other downloads after first completes</td> </tr> </tbody> </table> <p>More details can be found at <a href="https://www.bittorrent.org/beps/bep_0003.html" rel="external nofollow noopener" target="_blank">https://www.bittorrent.org/beps/bep_0003.html</a>.</p> <p>For the project, there are a few simplifications.</p> <ol> <li> <p><strong>No torrents, no trackers</strong>. The peers are started simultaneously with peer ID, hostname, and port information stored in a <code class="language-plaintext highlighter-rouge">PeerInfo.txt</code> file. The fourth field <code class="language-plaintext highlighter-rouge">hasFile</code> is 1 if the peer starts with the entire file and 0 otherwise. All peers connect and handshake with each other.</p> <p>The remaining configuration parameters–unchoking interval, optimistic unchoking interval, piece size–are stored in <code class="language-plaintext highlighter-rouge">Common.cfg</code> as <code class="language-plaintext highlighter-rouge">key=value</code> pairs on separate lines.</p> </li> <li> <p><strong>Request-piece</strong>. Requests only has index as the payload. Only one piece is sent following a request. There is no cancel message.</p> </li> </ol> <h2 id="first-attempt">First Attempt</h2> <p>The implementation contains 4 Java classes.</p> <h3 id="config">Config</h3> <p>Before we can begin file sharing, we need to extract configuration settings from <code class="language-plaintext highlighter-rouge">Common.cfg</code> and <code class="language-plaintext highlighter-rouge">PeerInfo.cfg</code>. The Java <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Properties.html" rel="external nofollow noopener" target="_blank">Properties</a> class manages configuration parameters as String key-value pairs. The <code class="language-plaintext highlighter-rouge">load</code> method loads the data in a config file into a Properties object. However, most configuration values are integers and don’t need to be modified, so Config wraps Properties with a simple getter interface.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">Config</span><span class="o">(</span><span class="nc">String</span> <span class="n">filename</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">);</span>
            <span class="n">prop</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getInt</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">prop</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getString</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="message">Message</h3> <p>The <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java1/Message.java" rel="external nofollow noopener" target="_blank">Message</a> class contains static methods for creating different messages. Each message is an array of bytes. Because, messages often contain various 32 bit integers as 4 sequential bytes, the Message class has a <code class="language-plaintext highlighter-rouge">intToByteArray</code> helper method. The Message class also contains a <code class="language-plaintext highlighter-rouge">typeOf</code> method which returns the message type as a lowercase String. To prevent issues with misspellings, the Strings are stored as static variables.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HANDSHAKE</span> <span class="o">=</span> <span class="s">"handshake"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">CHOKE</span> <span class="o">=</span> <span class="s">"choke"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">UNCHOKE</span> <span class="o">=</span> <span class="s">"unchoke"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">INTERESTED</span> <span class="o">=</span> <span class="s">"interested"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">NOT_INTERESTED</span> <span class="o">=</span> <span class="s">"not interested"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HAVE</span> <span class="o">=</span> <span class="s">"have"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">BITFIELD</span> <span class="o">=</span> <span class="s">"bitfield"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">REQUEST</span> <span class="o">=</span> <span class="s">"request"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">PIECE</span> <span class="o">=</span> <span class="s">"piece"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">P2PFILESHARINGPROJ</span> <span class="o">=</span> <span class="s">"P2PFILESHARINGPROJ"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">handshake</span><span class="o">(</span><span class="kt">int</span> <span class="n">peerId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">32</span><span class="o">];</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">header</span> <span class="o">=</span> <span class="no">P2PFILESHARINGPROJ</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">header</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">18</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">peerIdBytes</span> <span class="o">=</span> <span class="n">intToByteArray</span><span class="o">(</span><span class="n">peerId</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">peerIdBytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">choke</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">unchoke</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">interested</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">notinterested</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">have</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">bitfield</span><span class="o">(</span><span class="nc">BitSet</span> <span class="n">bitarray</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">request</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">piece</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">filePiece</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">typeOf</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">byte</span> <span class="n">msgType</span> <span class="o">=</span> <span class="n">msg</span><span class="o">[</span><span class="mi">4</span><span class="o">];</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">handshakeHeader</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">18</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">handshakeHeader</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="no">P2PFILESHARINGPROJ</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">HANDSHAKE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">CHOKE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">UNCHOKE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">INTERESTED</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">NOT_INTERESTED</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">HAVE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">BITFIELD</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">6</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">REQUEST</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span> <span class="o">==</span> <span class="mi">7</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">PIECE</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"INVALID"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">intToByteArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="peer">Peer</h3> <p>The <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java1/Peer.java" rel="external nofollow noopener" target="_blank">Peer</a> class is the core of the program. It stores the peer ID, hostname, port, several configuration variables, reads the file to be shared if necessary, and initializes a <code class="language-plaintext highlighter-rouge">numPieces = fileSize / pieceSize + (fileSize % pieceSize == 0? 0 : 1)</code> length <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/BitSet.html" rel="external nofollow noopener" target="_blank">BitSet</a> that tracks which file pieces have been downloaded.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">peerId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">hostname</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">hasFile</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">numPieces</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">numPrefNeighbors</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">optimisticUnchokingInterval</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">unchokingInterval</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">pieceSize</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">filename</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BitSet</span> <span class="n">bitarray</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Peer</span><span class="o">&gt;</span> <span class="n">neighborsToConnect</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">pieces</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">Peer</span><span class="o">(</span><span class="kt">int</span> <span class="n">peerId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">hostname</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hasFile</span><span class="o">,</span> <span class="nc">Config</span> <span class="n">config</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Peer</span><span class="o">&gt;</span> <span class="n">peers</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">peerId</span> <span class="o">=</span> <span class="n">peerId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hasFile</span> <span class="o">=</span> <span class="n">hasFile</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">numPrefNeighbors</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"NumberOfPreferredNeighbors"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">optimisticUnchokingInterval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"OptimisticUnchokingInterval"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unchokingInterval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"UnchokingInterval"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pieceSize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"PieceSize"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">filename</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"FileName"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">neighborsToConnect</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">peers</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"FileSize"</span><span class="o">);</span>
        <span class="n">numPieces</span> <span class="o">=</span> <span class="n">fileSize</span> <span class="o">/</span> <span class="n">pieceSize</span> <span class="o">+</span> <span class="o">(</span><span class="n">fileSize</span> <span class="o">%</span> <span class="n">pieceSize</span> <span class="o">==</span> <span class="mi">0</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">bitarray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">numPieces</span><span class="o">);</span>
        <span class="n">bitarray</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasFile</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">readFile</span><span class="o">(</span><span class="n">numPieces</span><span class="o">);</span>
            <span class="n">bitarray</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">numPieces</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readFile</span><span class="o">(</span><span class="kt">int</span> <span class="n">numPieces</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numPieces</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">piece</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">pieceSize</span><span class="o">];</span>
                <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">piece</span><span class="o">);</span>
                <span class="n">pieces</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">piece</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="run">Run</h4> <p>After a peer is created, it needs to start opening and accepting connections. Java has a simple <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/Socket.html" rel="external nofollow noopener" target="_blank">Socket</a> class for initiating TCP connections to <code class="language-plaintext highlighter-rouge">hostname:port</code> and <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/ServerSocket.html" rel="external nofollow noopener" target="_blank">ServerSocket</a> for accepting incoming connections. After the connections are created, a task for each side of the connection is run using a thread pool. The concurrency prevents blocking while waiting for messages. Because of this concurrency, objects accessed by multiple threads must be thread-safe or protected using <code class="language-plaintext highlighter-rouge">synchronized</code>.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Peer</span> <span class="n">peer</span> <span class="o">:</span> <span class="n">neighborsToConnect</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConnectionHandler</span><span class="o">(</span><span class="n">peer</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s connected to Peer %s%n"</span><span class="o">,</span> <span class="n">peerId</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerHandler</span><span class="o">(</span><span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">()));</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="connectionserverhandler">Connection/ServerHandler</h4> <p>After a connection has been made/accepted, Connection/ServerHandler continue the P2P protocol logic. ConnectionHandler sends the first handshake message; the ServerHandler replies with a handshake. They are distinguished by initializing the superclass Handler’s <code class="language-plaintext highlighter-rouge">initateHandhake</code> field differently. From the handshake messages, each side learns the ID of the other. Aside from this, the protocol logic is symmetric for both sides of a connection.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ConnectionHandler</span> <span class="kd">extends</span> <span class="nc">Peer</span><span class="o">.</span><span class="na">Handler</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="nf">ConnectionHandler</span><span class="o">(</span><span class="nc">Peer</span> <span class="n">peer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">hostname</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">port</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ServerHandler</span> <span class="kd">extends</span> <span class="nc">Peer</span><span class="o">.</span><span class="na">Handler</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="nf">ServerHandler</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="handler">Handler</h4> <p>The Handler class contains the protocol logic. At the core is an event loop that cycles between receiving messages, replying, unchoking peers, and sending have messages (in an altered order). To ensure each stage is visited, the socket has a timeout of 1 second. The loop concludes only when all peers have all pieces: the number of <code class="language-plaintext highlighter-rouge">Trues</code> in the BitSet = <code class="language-plaintext highlighter-rouge">numPieces</code>. Hence, each peer must maintain copy BitSet’s of its neighbors from the broadcasted have messages.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">RCV_TIMEOUT</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">BitSet</span><span class="o">&gt;</span> <span class="n">neighborBitarrays</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">missingPieces</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bitarray</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">bitarray</span><span class="o">.</span><span class="na">cardinality</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">numPieces</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">neighborsMissingPieces</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">BitSet</span> <span class="n">otherBitarray</span> <span class="o">:</span> <span class="n">neighborBitarrays</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">otherBitarray</span><span class="o">.</span><span class="na">cardinality</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">numPieces</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">otherPeerId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="nc">ObjectInputStream</span> <span class="n">in</span><span class="o">;</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">out</span><span class="o">;</span>
        <span class="nc">RandomAccessFile</span> <span class="n">raf</span><span class="o">;</span>
        <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">initiateHandshake</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Handler</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">initiateHandshake</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">missingPieces</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"./peer_%s/%s"</span><span class="o">,</span> <span class="n">peerId</span><span class="o">,</span> <span class="n">filename</span><span class="o">);</span>
                    <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
                    <span class="n">file</span><span class="o">.</span><span class="na">getParentFile</span><span class="o">().</span><span class="na">mkdirs</span><span class="o">();</span>
                    <span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
                    <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">initiateHandshake</span> <span class="o">=</span> <span class="n">initiateHandshake</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="no">RCV_TIMEOUT</span><span class="o">);</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">initiateHandshake</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">handshake</span><span class="o">(</span><span class="n">peerId</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>

                <span class="k">while</span> <span class="o">(</span><span class="n">missingPieces</span><span class="o">()</span> <span class="o">||</span> <span class="n">neighborsMissingPieces</span><span class="o">()</span> <span class="o">||</span> <span class="n">neighborBitarrays</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">unchoke</span><span class="o">();</span>
                    <span class="n">sendHaves</span><span class="o">();</span>
                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">rcv</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">respond</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s closed connection with Peer %s%n"</span><span class="o">,</span> <span class="n">peerId</span><span class="o">,</span> <span class="n">otherPeerId</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SocketException</span> <span class="o">|</span> <span class="nc">EOFException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s-%s connection was closed%n"</span><span class="o">,</span> <span class="n">peerId</span><span class="o">,</span> <span class="n">otherPeerId</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">rcv</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s received %s from Peer %s%n"</span><span class="o">,</span>
                        <span class="n">peerId</span><span class="o">,</span> <span class="nc">Message</span><span class="o">.</span><span class="na">typeOf</span><span class="o">(</span><span class="n">msg</span><span class="o">),</span> <span class="n">otherPeerId</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SocketTimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">respond</code> method implements response behavior of the protocol. For a new peer A connecting to a peer B that has the entire file, the sequence of messages is as follows. Interest is determined by taking the difference of the two BitSets. If the difference is all <code class="language-plaintext highlighter-rouge">False</code>, then B has no pieces A does not already have.</p> \[bitarray - otherBitarray = bitarray \land \neg otherBitarray\] <div class="jekyll-diagrams diagrams mermaid"> <svg id="mermaid-1696307912618" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:450px;" viewbox="-50 -10 450 266"><style>#mermaid-1696307912618 .label{font-family:trebuchet ms,verdana,arial;color:#333}#mermaid-1696307912618 .node circle,#mermaid-1696307912618 .node ellipse,#mermaid-1696307912618 .node polygon,#mermaid-1696307912618 .node rect{fill:#ececff;stroke:#9370db;stroke-width:1px}#mermaid-1696307912618 .node.clickable{cursor:pointer}#mermaid-1696307912618 .arrowheadPath{fill:#333}#mermaid-1696307912618 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1696307912618 .edgeLabel{background-color:#e8e8e8}#mermaid-1696307912618 .cluster rect{fill:#ffffde!important;stroke:#aa3!important;stroke-width:1px!important}#mermaid-1696307912618 .cluster text{fill:#333}#mermaid-1696307912618 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:trebuchet ms,verdana,arial;font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1696307912618 .actor{stroke:#ccf;fill:#ececff}#mermaid-1696307912618 text.actor{fill:#000;stroke:none}#mermaid-1696307912618 .actor-line{stroke:grey}#mermaid-1696307912618 .messageLine0{marker-end:"url(#arrowhead)"}#mermaid-1696307912618 .messageLine0,#mermaid-1696307912618 .messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#mermaid-1696307912618 #arrowhead{fill:#333}#mermaid-1696307912618 #crosshead path{fill:#333!important;stroke:#333!important}#mermaid-1696307912618 .messageText{fill:#333;stroke:none}#mermaid-1696307912618 .labelBox{stroke:#ccf;fill:#ececff}#mermaid-1696307912618 .labelText,#mermaid-1696307912618 .loopText{fill:#000;stroke:none}#mermaid-1696307912618 .loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#ccf}#mermaid-1696307912618 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1696307912618 .noteText{fill:#000;stroke:none;font-family:trebuchet ms,verdana,arial;font-size:14px}#mermaid-1696307912618 .section{stroke:none;opacity:.2}#mermaid-1696307912618 .section0{fill:rgba(102,102,255,.49)}#mermaid-1696307912618 .section2{fill:#fff400}#mermaid-1696307912618 .section1,#mermaid-1696307912618 .section3{fill:#fff;opacity:.2}#mermaid-1696307912618 .sectionTitle0,#mermaid-1696307912618 .sectionTitle1,#mermaid-1696307912618 .sectionTitle2,#mermaid-1696307912618 .sectionTitle3{fill:#333}#mermaid-1696307912618 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px}#mermaid-1696307912618 .grid .tick{stroke:#d3d3d3;opacity:.3;shape-rendering:crispEdges}#mermaid-1696307912618 .grid path{stroke-width:0}#mermaid-1696307912618 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1696307912618 .task{stroke-width:2}#mermaid-1696307912618 .taskText{text-anchor:middle;font-size:11px}#mermaid-1696307912618 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}#mermaid-1696307912618 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1696307912618 .taskText0,#mermaid-1696307912618 .taskText1,#mermaid-1696307912618 .taskText2,#mermaid-1696307912618 .taskText3{fill:#fff}#mermaid-1696307912618 .task0,#mermaid-1696307912618 .task1,#mermaid-1696307912618 .task2,#mermaid-1696307912618 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1696307912618 .taskTextOutside0,#mermaid-1696307912618 .taskTextOutside1,#mermaid-1696307912618 .taskTextOutside2,#mermaid-1696307912618 .taskTextOutside3{fill:#000}#mermaid-1696307912618 .active0,#mermaid-1696307912618 .active1,#mermaid-1696307912618 .active2,#mermaid-1696307912618 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1696307912618 .activeText0,#mermaid-1696307912618 .activeText1,#mermaid-1696307912618 .activeText2,#mermaid-1696307912618 .activeText3{fill:#000!important}#mermaid-1696307912618 .done0,#mermaid-1696307912618 .done1,#mermaid-1696307912618 .done2,#mermaid-1696307912618 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1696307912618 .doneText0,#mermaid-1696307912618 .doneText1,#mermaid-1696307912618 .doneText2,#mermaid-1696307912618 .doneText3{fill:#000!important}#mermaid-1696307912618 .crit0,#mermaid-1696307912618 .crit1,#mermaid-1696307912618 .crit2,#mermaid-1696307912618 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1696307912618 .activeCrit0,#mermaid-1696307912618 .activeCrit1,#mermaid-1696307912618 .activeCrit2,#mermaid-1696307912618 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1696307912618 .doneCrit0,#mermaid-1696307912618 .doneCrit1,#mermaid-1696307912618 .doneCrit2,#mermaid-1696307912618 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1696307912618 .activeCritText0,#mermaid-1696307912618 .activeCritText1,#mermaid-1696307912618 .activeCritText2,#mermaid-1696307912618 .activeCritText3,#mermaid-1696307912618 .doneCritText0,#mermaid-1696307912618 .doneCritText1,#mermaid-1696307912618 .doneCritText2,#mermaid-1696307912618 .doneCritText3{fill:#000!important}#mermaid-1696307912618 .titleText{text-anchor:middle;font-size:18px;fill:#000}
#mermaid-1696307912618 g.classGroup text{fill:#9370db;stroke:none;font-family:trebuchet ms,verdana,arial;font-size:10px}#mermaid-1696307912618 g.classGroup rect{fill:#ececff;stroke:#9370db}#mermaid-1696307912618 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1696307912618 .classLabel .box{stroke:none;stroke-width:0;fill:#ececff;opacity:.5}#mermaid-1696307912618 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1696307912618 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1696307912618 #compositionEnd,#mermaid-1696307912618 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1696307912618 #aggregationEnd,#mermaid-1696307912618 #aggregationStart{fill:#ececff;stroke:#9370db;stroke-width:1}#mermaid-1696307912618 #dependencyEnd,#mermaid-1696307912618 #dependencyStart,#mermaid-1696307912618 #extensionEnd,#mermaid-1696307912618 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1696307912618 .branch-label,#mermaid-1696307912618 .commit-id,#mermaid-1696307912618 .commit-msg{fill:#d3d3d3;color:#d3d3d3}</style> <style>#mermaid-1696307912618{color:#000;font:normal normal 400 normal 16px / normal "Times New Roman"}</style> <g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="255" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="75" dy="0">A</tspan></text></g><g><line id="actor1" x1="275" y1="5" x2="275" y2="255" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="275" dy="0">B</tspan></text></g><defs><marker id="arrowhead" refx="5" refy="2" markerwidth="6" markerheight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerwidth="15" markerheight="8" orient="auto" refx="16" refy="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">Message.handshake(A.peerId)</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="128" class="messageText" style="text-anchor: middle;">Message.handshake(B.peerId), Message.bitfield(B.bitarray)</text><line x1="275" y1="135" x2="75" y2="135" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><text x="175" y="163" class="messageText" style="text-anchor: middle;">Message.interested()</text><line x1="75" y1="170" x2="275" y2="170" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="0" y="190" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="222.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="75" dy="0">A</tspan></text></g><g><rect x="200" y="190" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="222.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="275" dy="0">B</tspan></text></g></svg> </div> <p>Upon receiving the interested message, B adds A to its list of interested peers. Eventually, B sends an unchoke message to A. Peer A randomly selects a piece to request from the difference of the BitSets.</p> <div class="jekyll-diagrams diagrams mermaid"> <svg id="mermaid-1696307913099" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:450px;" viewbox="-50 -10 450 301"><style>#mermaid-1696307913099 .label{font-family:trebuchet ms,verdana,arial;color:#333}#mermaid-1696307913099 .node circle,#mermaid-1696307913099 .node ellipse,#mermaid-1696307913099 .node polygon,#mermaid-1696307913099 .node rect{fill:#ececff;stroke:#9370db;stroke-width:1px}#mermaid-1696307913099 .node.clickable{cursor:pointer}#mermaid-1696307913099 .arrowheadPath{fill:#333}#mermaid-1696307913099 .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-1696307913099 .edgeLabel{background-color:#e8e8e8}#mermaid-1696307913099 .cluster rect{fill:#ffffde!important;stroke:#aa3!important;stroke-width:1px!important}#mermaid-1696307913099 .cluster text{fill:#333}#mermaid-1696307913099 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:trebuchet ms,verdana,arial;font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-1696307913099 .actor{stroke:#ccf;fill:#ececff}#mermaid-1696307913099 text.actor{fill:#000;stroke:none}#mermaid-1696307913099 .actor-line{stroke:grey}#mermaid-1696307913099 .messageLine0{marker-end:"url(#arrowhead)"}#mermaid-1696307913099 .messageLine0,#mermaid-1696307913099 .messageLine1{stroke-width:1.5;stroke-dasharray:"2 2";stroke:#333}#mermaid-1696307913099 #arrowhead{fill:#333}#mermaid-1696307913099 #crosshead path{fill:#333!important;stroke:#333!important}#mermaid-1696307913099 .messageText{fill:#333;stroke:none}#mermaid-1696307913099 .labelBox{stroke:#ccf;fill:#ececff}#mermaid-1696307913099 .labelText,#mermaid-1696307913099 .loopText{fill:#000;stroke:none}#mermaid-1696307913099 .loopLine{stroke-width:2;stroke-dasharray:"2 2";marker-end:"url(#arrowhead)";stroke:#ccf}#mermaid-1696307913099 .note{stroke:#aa3;fill:#fff5ad}#mermaid-1696307913099 .noteText{fill:#000;stroke:none;font-family:trebuchet ms,verdana,arial;font-size:14px}#mermaid-1696307913099 .section{stroke:none;opacity:.2}#mermaid-1696307913099 .section0{fill:rgba(102,102,255,.49)}#mermaid-1696307913099 .section2{fill:#fff400}#mermaid-1696307913099 .section1,#mermaid-1696307913099 .section3{fill:#fff;opacity:.2}#mermaid-1696307913099 .sectionTitle0,#mermaid-1696307913099 .sectionTitle1,#mermaid-1696307913099 .sectionTitle2,#mermaid-1696307913099 .sectionTitle3{fill:#333}#mermaid-1696307913099 .sectionTitle{text-anchor:start;font-size:11px;text-height:14px}#mermaid-1696307913099 .grid .tick{stroke:#d3d3d3;opacity:.3;shape-rendering:crispEdges}#mermaid-1696307913099 .grid path{stroke-width:0}#mermaid-1696307913099 .today{fill:none;stroke:red;stroke-width:2px}#mermaid-1696307913099 .task{stroke-width:2}#mermaid-1696307913099 .taskText{text-anchor:middle;font-size:11px}#mermaid-1696307913099 .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px}#mermaid-1696307913099 .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-1696307913099 .taskText0,#mermaid-1696307913099 .taskText1,#mermaid-1696307913099 .taskText2,#mermaid-1696307913099 .taskText3{fill:#fff}#mermaid-1696307913099 .task0,#mermaid-1696307913099 .task1,#mermaid-1696307913099 .task2,#mermaid-1696307913099 .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-1696307913099 .taskTextOutside0,#mermaid-1696307913099 .taskTextOutside1,#mermaid-1696307913099 .taskTextOutside2,#mermaid-1696307913099 .taskTextOutside3{fill:#000}#mermaid-1696307913099 .active0,#mermaid-1696307913099 .active1,#mermaid-1696307913099 .active2,#mermaid-1696307913099 .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-1696307913099 .activeText0,#mermaid-1696307913099 .activeText1,#mermaid-1696307913099 .activeText2,#mermaid-1696307913099 .activeText3{fill:#000!important}#mermaid-1696307913099 .done0,#mermaid-1696307913099 .done1,#mermaid-1696307913099 .done2,#mermaid-1696307913099 .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-1696307913099 .doneText0,#mermaid-1696307913099 .doneText1,#mermaid-1696307913099 .doneText2,#mermaid-1696307913099 .doneText3{fill:#000!important}#mermaid-1696307913099 .crit0,#mermaid-1696307913099 .crit1,#mermaid-1696307913099 .crit2,#mermaid-1696307913099 .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-1696307913099 .activeCrit0,#mermaid-1696307913099 .activeCrit1,#mermaid-1696307913099 .activeCrit2,#mermaid-1696307913099 .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-1696307913099 .doneCrit0,#mermaid-1696307913099 .doneCrit1,#mermaid-1696307913099 .doneCrit2,#mermaid-1696307913099 .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-1696307913099 .activeCritText0,#mermaid-1696307913099 .activeCritText1,#mermaid-1696307913099 .activeCritText2,#mermaid-1696307913099 .activeCritText3,#mermaid-1696307913099 .doneCritText0,#mermaid-1696307913099 .doneCritText1,#mermaid-1696307913099 .doneCritText2,#mermaid-1696307913099 .doneCritText3{fill:#000!important}#mermaid-1696307913099 .titleText{text-anchor:middle;font-size:18px;fill:#000}
#mermaid-1696307913099 g.classGroup text{fill:#9370db;stroke:none;font-family:trebuchet ms,verdana,arial;font-size:10px}#mermaid-1696307913099 g.classGroup rect{fill:#ececff;stroke:#9370db}#mermaid-1696307913099 g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-1696307913099 .classLabel .box{stroke:none;stroke-width:0;fill:#ececff;opacity:.5}#mermaid-1696307913099 .classLabel .label{fill:#9370db;font-size:10px}#mermaid-1696307913099 .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-1696307913099 #compositionEnd,#mermaid-1696307913099 #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1696307913099 #aggregationEnd,#mermaid-1696307913099 #aggregationStart{fill:#ececff;stroke:#9370db;stroke-width:1}#mermaid-1696307913099 #dependencyEnd,#mermaid-1696307913099 #dependencyStart,#mermaid-1696307913099 #extensionEnd,#mermaid-1696307913099 #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-1696307913099 .branch-label,#mermaid-1696307913099 .commit-id,#mermaid-1696307913099 .commit-msg{fill:#d3d3d3;color:#d3d3d3}</style> <style>#mermaid-1696307913099{color:#000;font:normal normal 400 normal 16px / normal "Times New Roman"}</style> <g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="290" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="75" dy="0">A</tspan></text></g><g><line id="actor1" x1="275" y1="5" x2="275" y2="290" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="275" dy="0">B</tspan></text></g><defs><marker id="arrowhead" refx="5" refy="2" markerwidth="6" markerheight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerwidth="15" markerheight="8" orient="auto" refx="16" refy="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">Message.unchoke()</text><line x1="275" y1="100" x2="75" y2="100" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><text x="175" y="153" class="messageText" style="text-anchor: middle;">Message.request(index)</text><line x1="75" y1="160" x2="275" y2="160" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="188" class="messageText" style="text-anchor: middle;">Message.piece(index, B.piece.get(index))</text><line x1="275" y1="195" x2="75" y2="195" class="messageLine1" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="stroke-dasharray: 3, 3; fill: none;"></line></g><g><line x1="65" y1="110" x2="285" y2="110" class="loopLine"></line><line x1="285" y1="110" x2="285" y2="205" class="loopLine"></line><line x1="65" y1="205" x2="285" y2="205" class="loopLine"></line><line x1="65" y1="110" x2="65" y2="205" class="loopLine"></line><polygon points="65,110 115,110 115,123 106.6,130 65,130" class="labelBox"></polygon><text x="72.5" y="125" fill="black" class="labelText"><tspan x="72.5" fill="black">loop</tspan></text><text x="175" y="125" fill="black" class="loopText" style="text-anchor: middle;"><tspan x="175" fill="black">[ !A.hasAllPieces() ]</tspan></text></g><g><rect x="0" y="225" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="257.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="75" dy="0">A</tspan></text></g><g><rect x="200" y="225" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="257.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle;"><tspan x="275" dy="0">B</tspan></text></g></svg> </div> <p>Once A receives a piece, it must store the piece in memory<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> and on disk as well as mark the corresponding index BitSet as <code class="language-plaintext highlighter-rouge">True</code>. Finally, it broadcasts have messages to every other neighbor. This is achieved by maintaining a <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentLinkedQueue.html" rel="external nofollow noopener" target="_blank">ConcurrentLinkedQueue</a> for each <code class="language-plaintext highlighter-rouge">otherPeerId</code>. Once the respective Handler enters the <code class="language-plaintext highlighter-rouge">sendHaves</code> method, it sends all the messages in its queue.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">interestedNeighborIds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">haveQueues</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">piecesReceived</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">respond</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">msgType</span> <span class="o">=</span> <span class="nc">Message</span><span class="o">.</span><span class="na">typeOf</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">HANDSHAKE</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">otherPeerId</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">32</span><span class="o">));</span>
                <span class="n">haveQueues</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;());</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">initiateHandshake</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">handshake</span><span class="o">(</span><span class="n">peerId</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bitarray</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">bitarray</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">bitfield</span><span class="o">(</span><span class="n">bitarray</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">HAVE</span><span class="o">))</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">9</span><span class="o">));</span>
                <span class="n">neighborBitarrays</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">numPieces</span><span class="o">));</span>
                <span class="n">neighborBitarrays</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="n">notifyInterest</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">BITFIELD</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">BitSet</span> <span class="n">otherBitarray</span> <span class="o">=</span> <span class="nc">BitSet</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">length</span><span class="o">));</span>
                <span class="n">neighborBitarrays</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">,</span> <span class="n">otherBitarray</span><span class="o">);</span>
                <span class="n">notifyInterest</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">INTERESTED</span><span class="o">))</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">NOT_INTERESTED</span><span class="o">))</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">removeIf</span><span class="o">(</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="n">id</span> <span class="o">==</span> <span class="n">otherPeerId</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">CHOKE</span><span class="o">))</span> <span class="o">{</span>

            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">UNCHOKE</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">requestPiece</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">REQUEST</span><span class="o">))</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">9</span><span class="o">));</span>
                <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">piece</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">pieces</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">)));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msgType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">PIECE</span><span class="o">))</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">9</span><span class="o">));</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">piece</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="n">pieces</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">piece</span><span class="o">);</span>
                <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">pieceSize</span><span class="o">);</span>
                <span class="n">raf</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">piece</span><span class="o">);</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bitarray</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">bitarray</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">piecesReceived</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                <span class="n">piecesReceived</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">,</span> <span class="n">piecesReceived</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">:</span> <span class="n">haveQueues</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">requestPiece</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="nf">byteArrayToInt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">);</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyInterest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">requestPiece</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">BitSet</span> <span class="nf">missingBitArray</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendHaves</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>The last unmentioned phase is the <code class="language-plaintext highlighter-rouge">unchoke</code> method. Unchoking is done tit-for-tat at regular intervals; the peers which have sent the most pieces are allowed to request pieces. Periodically, a choked but interested peer is optimistically unchoked. In the beginning, no pieces have been sent, so no peers will be unchoked. Instead of waiting for peers to optimistically each other, peers starting with the complete file unchoke a random subset of their interested neighbors.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">unchokedNeighborIds</span> <span class="o">=</span> <span class="nc">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">toSendUnchokeIds</span> <span class="o">=</span> <span class="nc">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">toSendChokeIds</span> <span class="o">=</span> <span class="nc">ConcurrentHashMap</span><span class="o">.</span><span class="na">newKeySet</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lastOptimistic</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lastUnchoked</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">optimisticallyUnchokedId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unchoke</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bitarray</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">hasFile</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">unchokedNeighborIds</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="o">&amp;&amp;</span> <span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">numPrefNeighbors</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">Collections</span><span class="o">.</span><span class="na">shuffle</span><span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">);</span>
                        <span class="n">unchokedNeighborIds</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
                        <span class="n">toSendUnchokeIds</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">unchokedNeighborIds</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">chokedButInterestedIds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">interestedNeighborIds</span><span class="o">);</span>
                    <span class="n">chokedButInterestedIds</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">unchokedNeighborIds</span><span class="o">);</span>

                    <span class="kt">long</span> <span class="n">sinceLastOptimistic</span> <span class="o">=</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastOptimistic</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">sinceLastOptimistic</span> <span class="o">&gt;=</span> <span class="n">optimisticUnchokingInterval</span> <span class="o">&amp;&amp;</span> <span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">randInt</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">chokedButInterestedIds</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                        <span class="kt">int</span> <span class="n">randId</span> <span class="o">=</span> <span class="n">chokedButInterestedIds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">randInt</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">randId</span> <span class="o">!=</span> <span class="n">optimisticallyUnchokedId</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">toSendUnchokeIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">randId</span><span class="o">);</span>
                            <span class="n">toSendChokeIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">optimisticallyUnchokedId</span><span class="o">);</span>
                            <span class="n">optimisticallyUnchokedId</span> <span class="o">=</span> <span class="n">randId</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">lastOptimistic</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="kt">long</span> <span class="n">sinceLastUnchoked</span> <span class="o">=</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastUnchoked</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">sinceLastUnchoked</span> <span class="o">&gt;=</span> <span class="n">unchokingInterval</span> <span class="o">&amp;&amp;</span> <span class="n">piecesReceived</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">entries</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">piecesReceived</span><span class="o">.</span><span class="na">entrySet</span><span class="o">());</span>
                        <span class="n">entries</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="nc">Entry</span><span class="o">.</span><span class="na">comparingByValue</span><span class="o">());</span>
                        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">topIds</span> <span class="o">=</span> <span class="n">entries</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">Entry:</span><span class="o">:</span><span class="n">getKey</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>
                        <span class="n">toSendChokeIds</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">difference</span><span class="o">(</span><span class="n">unchokedNeighborIds</span><span class="o">,</span> <span class="n">topIds</span><span class="o">));</span>
                        <span class="n">toSendUnchokeIds</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">difference</span><span class="o">(</span><span class="n">topIds</span><span class="o">,</span> <span class="n">unchokedNeighborIds</span><span class="o">));</span>
                        <span class="n">unchokedNeighborIds</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                        <span class="n">unchokedNeighborIds</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">topIds</span><span class="o">);</span>
                        <span class="n">piecesReceived</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                        <span class="n">lastUnchoked</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">toSendUnchokeIds</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">unchoke</span><span class="o">());</span>
                        <span class="n">toSendUnchokeIds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">toSendChokeIds</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">choke</span><span class="o">());</span>
                        <span class="n">toSendUnchokeIds</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">otherPeerId</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">difference</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="startpeers">StartPeers</h3> <p>The <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java1/StartPeers.java" rel="external nofollow noopener" target="_blank">StartPeers</a> class makes it easier to start the file sharing process. It reads the lines in <code class="language-plaintext highlighter-rouge">PeerInfo.cfg</code> and spins up a new Peer in separate threads.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StartPeers</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">(</span><span class="s">"Common.cfg"</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Peer</span><span class="o">&gt;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="s">"PeerInfo.txt"</span><span class="o">));</span>
            <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">line</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span><span class="o">[]</span> <span class="n">info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">strip</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">peerId</span> <span class="o">=</span> <span class="n">toInt</span><span class="o">(</span><span class="n">info</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                <span class="nc">Peer</span> <span class="n">peer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Peer</span><span class="o">(</span><span class="n">peerId</span><span class="o">,</span> <span class="n">info</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">toInt</span><span class="o">(</span><span class="n">info</span><span class="o">[</span><span class="mi">2</span><span class="o">]),</span> <span class="n">toInt</span><span class="o">(</span><span class="n">info</span><span class="o">[</span><span class="mi">3</span><span class="o">]),</span> <span class="n">config</span><span class="o">,</span> <span class="n">peers</span><span class="o">);</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">peer</span><span class="o">);</span>
                <span class="n">peers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">peer</span><span class="o">);</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">toInt</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <h2 id="second-attempt">Second Attempt</h2> <p>There are a number of problems with this first attempted implementation.</p> <ol> <li> <strong>Peer</strong>. The Peer class is nearly 400 lines with multiple methods ~50 lines. Worse, the Peer class has 3 inner classes that concurrently act on the peer’s state. This results in a large number of ConcurrentHashMaps and <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/concurrent/ConcurrentHashMap.html#newKeySet()" rel="external nofollow noopener" target="_blank">ConcurrentHashMap.newKeySet()</a>’s. Un-thread-safe objects must be protected using <code class="language-plaintext highlighter-rouge">synchronized</code>. This is incredibly complicated and makes debugging/extending the existing Peer class difficult.</li> <li> <strong>Message</strong>. The Message class is longer than it needs to be. Notably, all the non-handshake messages share a common pattern: length prefix, type byte, and payload. Even the handshake message can be shoehorned into this tripartite format. A “length” prefix of P2PFILESHARINGPROJ, 10 empty type bytes, and a 4 byte payload of the peer ID. The Message class is littered with magic numbers. For example, the type codes $0, 1, \dots, 7$ appear multiple times instead of descriptive variable names.</li> </ol> <h3 id="messagetype">MessageType</h3> <p>Rather than represent the message types as Strings, we create a <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java2/MessageType.java" rel="external nofollow noopener" target="_blank">MessageType</a> enum with the type codes as a public field. The handshake message is assigned a type code of 10. The <code class="language-plaintext highlighter-rouge">valueOf</code> method can be used to convert type codes into MessageType values.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">MessageType</span> <span class="o">{</span>
    <span class="no">HANDSHAKE</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span>
    <span class="no">CHOKE</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
    <span class="no">UNCHOKE</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
    <span class="no">INTERESTED</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span>
    <span class="no">NOT_INTERESTED</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
    <span class="no">HAVE</span><span class="o">(</span><span class="mi">4</span><span class="o">),</span>
    <span class="no">BITFIELD</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span>
    <span class="no">REQUEST</span><span class="o">(</span><span class="mi">6</span><span class="o">),</span>
    <span class="no">PIECE</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>

    <span class="nc">MessageType</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">MessageType</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">byte</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">MessageType</span> <span class="n">type</span> <span class="o">:</span> <span class="nc">MessageType</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">code</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">type</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="message-1">Message</h3> <p>The <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java2/Message.java" rel="external nofollow noopener" target="_blank">Message</a> class has 3 fields corresponding to these 3 parts discussed previously. Messages can be converted into byte arrays for transmission by concatenating these fields together. The <code class="language-plaintext highlighter-rouge">typeOf</code> method has been replaced with a much shorter <code class="language-plaintext highlighter-rouge">parse</code> method that converts a byte array into the Message class. Handshake messages are generated directly and parsed into a Message object with payload = peer ID.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">P2PFILESHARINGPROJ</span> <span class="o">=</span> <span class="s">"P2PFILESHARINGPROJ"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">length</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">MessageType</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">payload</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Message</span><span class="o">(</span><span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="nc">MessageType</span> <span class="n">type</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">payload</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">length</span> <span class="o">=</span> <span class="n">length</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">toBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span><span class="n">intToBytes</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">length</span><span class="o">),</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{(</span><span class="kt">byte</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">code</span><span class="o">},</span> <span class="n">payload</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">concat</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">first</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]...</span> <span class="n">rest</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">handshake</span><span class="o">(</span><span class="kt">int</span> <span class="n">peerId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">concat</span><span class="o">(</span><span class="no">P2PFILESHARINGPROJ</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">10</span><span class="o">],</span> <span class="n">intToBytes</span><span class="o">(</span><span class="n">peerId</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">choke</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Message</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">MessageType</span><span class="o">.</span><span class="na">CHOKE</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{}).</span><span class="na">toBytes</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">unchoke</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">interested</span><span class="o">().</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">notinterested</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">have</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">bitfield</span><span class="o">(</span><span class="nc">BitSet</span> <span class="n">bitarray</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">request</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">piece</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">filePiece</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">intToBytes</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Message</span> <span class="nf">parse</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">18</span><span class="o">)).</span><span class="na">equals</span><span class="o">(</span><span class="no">P2PFILESHARINGPROJ</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Message</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">MessageType</span><span class="o">.</span><span class="na">HANDSHAKE</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">32</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Message</span><span class="o">(</span><span class="n">bytesToInt</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">)),</span>
                               <span class="nc">MessageType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">msg</span><span class="o">[</span><span class="mi">4</span><span class="o">]),</span>
                               <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">length</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">bytesToInt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="peer-1">Peer</h3> <p>The <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java2/Peer.java" rel="external nofollow noopener" target="_blank">Peer</a> class is mostly unchanged. It consists of peer specific attributes and is responsible for reading/writing to the file. Connection specific attributes and logic are excised to a separate class Connection, the successor to Handler. However, because Connections require access to some Peer-level fields, they are made public. Peers track open connections in a list <code class="language-plaintext highlighter-rouge">connections</code>.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">peerId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">hostname</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">hasFile</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">filename</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">pieceSize</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">numPieces</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">BitSet</span> <span class="n">bitarray</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">pieces</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Connection</span><span class="o">&gt;</span> <span class="n">connections</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Peer</span><span class="o">&gt;</span> <span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">Peer</span><span class="o">(</span><span class="kt">int</span> <span class="n">peerId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">hostname</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hasFile</span><span class="o">,</span> <span class="nc">Config</span> <span class="n">config</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Peer</span><span class="o">&gt;</span> <span class="n">peers</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">peerId</span> <span class="o">=</span> <span class="n">peerId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hostname</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hasFile</span> <span class="o">=</span> <span class="n">hasFile</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">peers</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">peers</span><span class="o">);</span>

        <span class="n">numPrefNeighbors</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"NumberOfPreferredNeighbors"</span><span class="o">);</span>
        <span class="n">optimisticUnchokingInterval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"OptimisticUnchokingInterval"</span><span class="o">);</span>
        <span class="n">unchokingInterval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"UnchokingInterval"</span><span class="o">);</span>
        <span class="n">pieceSize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"PieceSize"</span><span class="o">);</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"FileName"</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"FileSize"</span><span class="o">);</span>
        <span class="n">numPieces</span> <span class="o">=</span> <span class="n">fileSize</span> <span class="o">/</span> <span class="n">pieceSize</span> <span class="o">+</span> <span class="o">(</span><span class="n">fileSize</span> <span class="o">%</span> <span class="n">pieceSize</span> <span class="o">==</span> <span class="mi">0</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">bitarray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">numPieces</span><span class="o">);</span>
        <span class="n">bitarray</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">hasFile</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">readFile</span><span class="o">();</span>
            <span class="n">bitarray</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">numPieces</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readFile</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">FileInputStream</span> <span class="n">fileInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numPieces</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">piece</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">pieceSize</span><span class="o">];</span>
                <span class="n">fileInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">piece</span><span class="o">);</span>
                <span class="n">pieces</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">piece</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">missingPieces</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">neighborsMissingPieces</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="run-1">Run</h4> <p>The run method is unchanged, except now it must add new connections before submitting them and schedules the unchoking/optimistic unchoking tasks.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ScheduledExecutorService</span> <span class="n">scheduledThreadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newScheduledThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">numPrefNeighbors</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">optimisticUnchokingInterval</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">unchokingInterval</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">optimisticallyUnchokedId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">scheduledThreadPool</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span>
                    <span class="k">this</span><span class="o">::</span><span class="n">optimisticUnchoke</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">optimisticUnchokingInterval</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="n">scheduledThreadPool</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span>
                    <span class="k">this</span><span class="o">::</span><span class="n">unchoke</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">unchokingInterval</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Peer</span> <span class="n">peer</span> <span class="o">:</span> <span class="n">peers</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Connection</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">hostname</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">port</span><span class="o">),</span> <span class="k">this</span><span class="o">);</span>
                <span class="n">connections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s connected to Peer %s%n"</span><span class="o">,</span> <span class="n">peerId</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Connection</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
                <span class="n">connections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="unchoke">Unchoke</h4> <p>Unchoking is now performed by peers because it requires iterating through all connections. The peer schedules the task to be performed in a new thread periodically, saving us the trouble of checking the <code class="language-plaintext highlighter-rouge">lastUnchoked</code> time. Despite the presence of two extra threads, the peer state has shrunk. We no longer need the synchronized list <code class="language-plaintext highlighter-rouge">interestedNeighborIds</code> and the concurrent sets <code class="language-plaintext highlighter-rouge">unchokedNeighborIds</code>, <code class="language-plaintext highlighter-rouge">toSendUnchokeIds</code>, <code class="language-plaintext highlighter-rouge">toSendChokeIds</code><sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>. They take new life as local variables.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Peer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">optimisticUnchoke</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">chokedButInterestedIds</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">interested</span> <span class="o">&amp;&amp;</span> <span class="n">conn</span><span class="o">.</span><span class="na">choked</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">otherPeerId</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">chokedButInterestedIds</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">randInt</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">chokedButInterestedIds</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="kt">int</span> <span class="n">randId</span> <span class="o">=</span> <span class="n">chokedButInterestedIds</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">randInt</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">randId</span> <span class="o">!=</span> <span class="n">optimisticallyUnchokedId</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">:</span> <span class="n">connections</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sendChokeAndUnchoke</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">optimisticallyUnchokedId</span><span class="o">),</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">randId</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">optimisticallyUnchokedId</span> <span class="o">=</span> <span class="n">randId</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unchoke</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">unchokedNeighborIds</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">conn</span><span class="o">.</span><span class="na">choked</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">otherPeerId</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">interestedNeighborIds</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">interested</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">otherPeerId</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Connection</span><span class="o">&gt;</span> <span class="n">usefulConnections</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">piecesReceived</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">toChoke</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">toUnchoke</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasFile</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">unchokedNeighborIds</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="o">&amp;&amp;</span> <span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">shuffle</span><span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">);</span>
            <span class="n">toUnchoke</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">interestedNeighborIds</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">usefulConnections</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">connections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">piecesReceived</span><span class="o">));</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">topIds</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">numPrefNeighbors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="n">conn</span><span class="o">.</span><span class="na">otherPeerId</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
            <span class="n">toChoke</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">difference</span><span class="o">(</span><span class="n">unchokedNeighborIds</span><span class="o">,</span> <span class="n">topIds</span><span class="o">));</span>
            <span class="n">toUnchoke</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">difference</span><span class="o">(</span><span class="n">topIds</span><span class="o">,</span> <span class="n">unchokedNeighborIds</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">:</span> <span class="n">connections</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">conn</span><span class="o">.</span><span class="na">piecesReceived</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">sendChokeAndUnchoke</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">toChoke</span><span class="o">,</span> <span class="n">toUnchoke</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendChokeAndUnchoke</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">toChoke</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">toUnchoke</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">toChoke</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">conn</span><span class="o">.</span><span class="na">otherPeerId</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">choke</span><span class="o">());</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">choked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">toUnchoke</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">conn</span><span class="o">.</span><span class="na">otherPeerId</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">unchoke</span><span class="o">());</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">choked</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">difference</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">a</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="connection">Connection</h3> <p>The receive-response loop is kept in the <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/java2/Connection.java" rel="external nofollow noopener" target="_blank">Connection</a> class. Because the class is no longer responsible for unchoking, it no longer needs a set socket timeout. Once a connection finishes, it removes itself from its peer’s list of connections.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Connection</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">BitSet</span> <span class="n">otherBitarray</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">otherPeerId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">interested</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">choked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">piecesReceived</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">initiateHandshake</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Peer</span> <span class="n">peer</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ObjectInputStream</span> <span class="n">in</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ObjectOutputStream</span> <span class="n">out</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">RandomAccessFile</span> <span class="n">raf</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Connection</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">initiateHandshake</span><span class="o">,</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">,</span> <span class="nc">Peer</span> <span class="n">peer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">initiateHandshake</span> <span class="o">=</span> <span class="n">initiateHandshake</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">peer</span> <span class="o">=</span> <span class="n">peer</span><span class="o">;</span>
        <span class="n">otherBitarray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">numPieces</span><span class="o">);</span>
        <span class="n">otherBitarray</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">hasFile</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"./peer_%s/%s"</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">filename</span><span class="o">);</span>
                <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
                <span class="n">file</span><span class="o">.</span><span class="na">getParentFile</span><span class="o">().</span><span class="na">mkdirs</span><span class="o">();</span>
                <span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
                <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
            <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">initiateHandshake</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">handshake</span><span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">));</span>
            <span class="o">}</span>

            <span class="k">while</span> <span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">missingPieces</span><span class="o">()</span> <span class="o">||</span> <span class="n">peer</span><span class="o">.</span><span class="na">neighborsMissingPieces</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">respond</span><span class="o">(</span><span class="n">rcv</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s closed connection with Peer %s%n"</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">,</span> <span class="n">otherPeerId</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SocketException</span> <span class="o">|</span> <span class="nc">EOFException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s-%s connection was closed%n"</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">,</span> <span class="n">otherPeerId</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">peer</span><span class="o">.</span><span class="na">connections</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Message</span> <span class="nf">rcv</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Peer %s received %s from Peer %s%n"</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">,</span> <span class="n">getType</span><span class="o">(</span><span class="n">msg</span><span class="o">),</span> <span class="n">otherPeerId</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Message</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">respond</code> method is much as before, but now we can use an enhanced switch statement because the message types are an enum. Instead of saving haves in separate queues, we hijack the individual connections and force them to send have immediately.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Connection</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Message</span> <span class="nf">rcv</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getType</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">msg</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">respond</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="no">HANDSHAKE</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">otherPeerId</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">initiateHandshake</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">handshake</span><span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">peerId</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">bitarray</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">peer</span><span class="o">.</span><span class="na">bitarray</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">bitfield</span><span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">bitarray</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="no">CHOKE</span> <span class="o">-&gt;</span> <span class="o">{}</span>
            <span class="k">case</span> <span class="no">UNCHOKE</span> <span class="o">-&gt;</span> <span class="n">requestPiece</span><span class="o">();</span>
            <span class="k">case</span> <span class="no">INTERESTED</span> <span class="o">-&gt;</span> <span class="n">interested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">case</span> <span class="no">NOT_INTERESTED</span> <span class="o">-&gt;</span> <span class="n">interested</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">case</span> <span class="no">HAVE</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
                <span class="n">otherBitarray</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="n">notifyInterest</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="no">BITFIELD</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">otherBitarray</span> <span class="o">=</span> <span class="nc">BitSet</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
                <span class="n">notifyInterest</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="no">REQUEST</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
                <span class="n">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">piece</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">peer</span><span class="o">.</span><span class="na">pieces</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">)));</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="no">PIECE</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">byteArrayToInt</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">));</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">piece</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">payload</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="n">peer</span><span class="o">.</span><span class="na">pieces</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">piece</span><span class="o">);</span>
                <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">peer</span><span class="o">.</span><span class="na">pieceSize</span><span class="o">);</span>
                <span class="n">raf</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">piece</span><span class="o">);</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">peer</span><span class="o">.</span><span class="na">bitarray</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">peer</span><span class="o">.</span><span class="na">bitarray</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">piecesReceived</span><span class="o">++;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">:</span> <span class="n">peer</span><span class="o">.</span><span class="na">connections</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">conn</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="na">have</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="n">requestPiece</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">byteArrayToInt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span><span class="n">l</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">requestPiece</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">notifyInterest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">BitSet</span> <span class="nf">missingBitarray</span><span class="o">();</span>
<span class="o">}</span>

</code></pre></div></div> <h2 id="in-a-different-language">In a Different Language</h2> <p>We reimplement Attempt 2 in Python to see how code changes using a different language with different libraries and different customs. Some superficial (for our use case) differences are</p> <ul> <li>the use of lowercase_snake_case instead of CamelCase</li> <li>private methods are denoted by a leading _</li> <li>type declaration are not required</li> </ul> <p>Typically, unimplemented functions are written as</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">raise</span> <span class="nb">NotImplementedError</span>
</code></pre></div></div> <p>To save space, we omit the second line and colon from our function signatures.</p> <h3 id="config-1">Config</h3> <p>While Python has <a href="https://docs.python.org/3/library/configparser.html" rel="external nofollow noopener" target="_blank">configparser</a> for reading configuration files, it requires section headers which <code class="language-plaintext highlighter-rouge">Common.cfg</code> does not have. So <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/python/config.py" rel="external nofollow noopener" target="_blank">config</a> manually processes <code class="language-plaintext highlighter-rouge">Common.cfg</code> into key value pairs using <code class="language-plaintext highlighter-rouge">open</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">():</span>
                <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">=</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_int</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_str</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cfg</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

</code></pre></div></div> <h3 id="message-2">Message</h3> <p>Instead of a MessageType enum, the message type numbers are just variables in the module. Instead of all message creation/parsing methods being static, they are just ordinary functions in the <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/python/message.py" rel="external nofollow noopener" target="_blank">message</a> module. Some space is saved because Python’s <code class="language-plaintext highlighter-rouge">bytes</code> type supports concatenation using + and creating using the <code class="language-plaintext highlighter-rouge">b'string'</code> syntax.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDSHAKE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">CHOKE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">UNCHOKE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">INTERESTED</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">NOT_INTERESTED</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">HAVE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">BITFIELD</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">REQUEST</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">PIECE</span> <span class="o">=</span> <span class="mi">7</span>

<span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="n">self</span><span class="p">.</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">msg_type</span>
        <span class="n">self</span><span class="p">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span>

    <span class="k">def</span> <span class="nf">to_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">length</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="nb">type</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">payload</span>

<span class="k">def</span> <span class="nf">handshake</span><span class="p">():</span>
    <span class="k">return</span> <span class="nf">bytes</span><span class="p">(</span><span class="sh">'</span><span class="s">P2PFILESHARINGPROJ</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ascii</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\0\0\0\0\0\0\0\0\0\0</span><span class="sh">'</span> <span class="o">+</span> <span class="n">peer_id</span><span class="p">.</span><span class="nf">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">choke</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">unchoke</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">interested</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">notinterested</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">have</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bitfield</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">piece</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">file_piece</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></div> <h3 id="peer-2">Peer</h3> <p>A big difference between the Java and Python implementation is that instead of running peers in separate threads, we run them in separate processes using <a href="https://docs.python.org/3/library/multiprocessing.html" rel="external nofollow noopener" target="_blank">multiprocessing</a> as mp.<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> The class Peer in the <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/python/peer.py" rel="external nofollow noopener" target="_blank">peer</a> module is now a subclass of Process. Because of this, rather than maintain a list of peers, <code class="language-plaintext highlighter-rouge">peer_info</code> is a list of <code class="language-plaintext highlighter-rouge">(hostname, port)</code> pairs, as the Peer class must be serializable by <a href="https://docs.python.org/3/library/pickle.html" rel="external nofollow noopener" target="_blank">pickle</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Peer</span><span class="p">(</span><span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">peer_id</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">has_file</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">peer_info</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Peer</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">peer_id</span> <span class="o">=</span> <span class="n">peer_id</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span>
        <span class="n">self</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="n">self</span><span class="p">.</span><span class="n">has_file</span> <span class="o">=</span> <span class="n">has_file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">peer_info</span> <span class="o">=</span> <span class="n">peer_info</span>

        <span class="n">self</span><span class="p">.</span><span class="n">piece_size</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_int</span><span class="p">(</span><span class="sh">'</span><span class="s">PieceSize</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_int</span><span class="p">(</span><span class="sh">'</span><span class="s">FileSize</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optim_unchoking_int</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_int</span><span class="p">(</span><span class="sh">'</span><span class="s">OptimisticUnchokingInterval</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">unchoking_int</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_int</span><span class="p">(</span><span class="sh">'</span><span class="s">UnchokingInterval</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_int</span><span class="p">(</span><span class="sh">'</span><span class="s">NumberOfPreferredNeighbors</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">num_pieces</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">piece_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">piece_size</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">file_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">arr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">.</span><span class="nf">bitarray</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_pieces</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pieces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">has_file</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_str</span><span class="p">(</span><span class="sh">'</span><span class="s">FileName</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_pieces</span><span class="p">):</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">pieces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">piece_size</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">arr</span><span class="p">.</span><span class="nf">setall</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">./peer_</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">peer_id</span><span class="si">}</span><span class="sh">'</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">cfg</span><span class="p">.</span><span class="nf">get_str</span><span class="p">(</span><span class="sh">'</span><span class="s">FileName</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">arr</span><span class="p">.</span><span class="nf">setall</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">repeating</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">optim_unchoking_int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_optimistic_unchoke</span><span class="p">).</span><span class="nf">start</span><span class="p">()</span>
        <span class="n">repeating</span><span class="p">.</span><span class="nc">Timer</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">unchoking_int</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_unchoke</span><span class="p">).</span><span class="nf">start</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">peer_info</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">sock</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="nc">Connection</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">start</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">server_sock</span><span class="p">:</span>
            <span class="n">server_sock</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">port</span><span class="p">))</span>
            <span class="n">server_sock</span><span class="p">.</span><span class="nf">listen</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">sock</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server_sock</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="nc">Connection</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>
                <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_optimistic_unchoke</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">choked_but_interested_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">interested</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">.</span><span class="n">choked</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">choked_but_interested_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rand_id</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">choked_but_interested_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rand_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
                    <span class="nf">send_choke_and_unchoke</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span><span class="p">],</span> <span class="p">[</span><span class="n">rand_id</span><span class="p">])</span>
            <span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span> <span class="o">=</span> <span class="n">rand_id</span>

    <span class="k">def</span> <span class="nf">_unchoke</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">unchoked_neighbor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="p">.</span><span class="n">choked</span><span class="p">]</span>
        <span class="n">interested_neighbor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">interested</span><span class="p">]</span>
        <span class="n">useful_conn</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">pieces_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">has_file</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">unchoked_neighbor_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">interested_neighbor_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">random</span><span class="p">.</span><span class="nf">shuffle</span><span class="p">(</span><span class="n">interested_neighbor_ids</span><span class="p">)</span>
            <span class="n">to_choke</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">to_unchoke</span> <span class="o">=</span> <span class="n">interested_neighbor_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">useful_conn</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">top_connections</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">useful_conn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">conn</span><span class="p">:</span> <span class="n">conn</span><span class="p">.</span><span class="n">pieces_received</span><span class="p">)</span>
            <span class="n">top_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">top_connections</span><span class="p">[:</span><span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">to_choke</span> <span class="o">=</span> <span class="nf">difference</span><span class="p">(</span><span class="n">unchoked_neighbor_ids</span><span class="p">,</span> <span class="n">top_ids</span><span class="p">)</span>
            <span class="n">to_unchoke</span> <span class="o">=</span> <span class="nf">difference</span><span class="p">(</span><span class="n">top_ids</span><span class="p">,</span> <span class="n">unchoked_neighbor_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">pieces_received</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nf">send_choke_and_unchoke</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">to_choke</span><span class="p">,</span> <span class="n">to_unchoke</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">missing_pieces</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">neighbor_missing_pieces</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</code></pre></div></div> <h4 id="unchoke-1">Unchoke</h4> <p>The <code class="language-plaintext highlighter-rouge">_optimistic_unchoke</code> and <code class="language-plaintext highlighter-rouge">_unchoke</code> threads are run in separate threads. These functions are shorted due to the conciseness of list comprehensions compared to Java’s stream API. We abbreviate <code class="language-plaintext highlighter-rouge">NumberOfPreferredNeighbors</code> as <code class="language-plaintext highlighter-rouge">self.np</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">send_choke_and_unchoke</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">to_choke</span><span class="p">,</span> <span class="n">to_unchoke</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Peer</span><span class="p">(</span><span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_optimistic_unchoke</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">choked_but_interested_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">interested</span> <span class="ow">and</span> <span class="n">conn</span><span class="p">.</span><span class="n">choked</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">choked_but_interested_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rand_id</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">choked_but_interested_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rand_id</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
                    <span class="nf">send_choke_and_unchoke</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span><span class="p">],</span> <span class="p">[</span><span class="n">rand_id</span><span class="p">])</span>
            <span class="n">self</span><span class="p">.</span><span class="n">optim_unchoked_id</span> <span class="o">=</span> <span class="n">rand_id</span>

    <span class="k">def</span> <span class="nf">_unchoke</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">unchoked_neighbor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="p">.</span><span class="n">choked</span><span class="p">]</span>
        <span class="n">interested_neighbor_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">interested</span><span class="p">]</span>
        <span class="n">useful_conn</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span> <span class="k">if</span> <span class="n">conn</span><span class="p">.</span><span class="n">pieces_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">has_file</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">unchoked_neighbor_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">interested_neighbor_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">random</span><span class="p">.</span><span class="nf">shuffle</span><span class="p">(</span><span class="n">interested_neighbor_ids</span><span class="p">)</span>
            <span class="n">to_choke</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">to_unchoke</span> <span class="o">=</span> <span class="n">interested_neighbor_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">useful_conn</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">top_connections</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">useful_conn</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">conn</span><span class="p">:</span> <span class="n">conn</span><span class="p">.</span><span class="n">pieces_received</span><span class="p">)</span>
            <span class="n">top_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">top_connections</span><span class="p">[:</span><span class="n">self</span><span class="p">.</span><span class="n">np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">to_choke</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">unchoked_neighbor_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nf">set</span><span class="p">(</span><span class="n">top_ids</span><span class="p">))</span>
            <span class="n">to_unchoke</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">top_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nf">set</span><span class="p">(</span><span class="n">unchoked_neighbor_ids</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">.</span><span class="n">pieces_received</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nf">send_choke_and_unchoke</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">to_choke</span><span class="p">,</span> <span class="n">to_unchoke</span><span class="p">)</span>
</code></pre></div></div> <h3 id="repeating">Repeating</h3> <p>Python natively does not support scheduling repeating tasks using the threading module. So we create a new Timer in the <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/python/repeating.py" rel="external nofollow noopener" target="_blank">repeating</a> module that extends <code class="language-plaintext highlighter-rouge">threading.Timer</code> to repeat regularly.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Timer</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Timer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">finished</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">interval</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">self</span><span class="p">.</span><span class="n">kwargs</span><span class="p">)</span>

</code></pre></div></div> <h3 id="connection-1">Connection</h3> <p>The <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/python/connection.py" rel="external nofollow noopener" target="_blank">connection</a> module consists of a Connection class which subclasses <code class="language-plaintext highlighter-rouge">threading.Thread</code>. A major difference is that the input/output streams in Java cleanly delineate between the end of one message and the start of another. The <code class="language-plaintext highlighter-rouge">rcv</code> function must make do this for us. The <code class="language-plaintext highlighter-rouge">socket.recv</code> function takes in a buffer size which caps the number of bytes returned. We loop until obtaining 4 bytes, upon which we can determine the length of the message.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">initiate_handshake</span><span class="p">,</span> <span class="n">peer</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span>
        <span class="n">self</span><span class="p">.</span><span class="n">initiate_handshake</span> <span class="o">=</span> <span class="n">initiate_handshake</span>
        <span class="n">self</span><span class="p">.</span><span class="n">peer</span> <span class="o">=</span> <span class="n">peer</span>

        <span class="n">self</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">other_arr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">.</span><span class="nf">bitarray</span><span class="p">(</span><span class="n">peer</span><span class="p">.</span><span class="n">num_pieces</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">other_arr</span><span class="p">.</span><span class="nf">setall</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">interested</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">choked</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pieces_received</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">initiate_handshake</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">handshake</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">peer_id</span><span class="p">))</span>

            <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="nf">missing_pieces</span><span class="p">()</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="nf">neighbor_missing_pieces</span><span class="p">():</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">respond</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">rcv</span><span class="p">())</span>

            <span class="n">self</span><span class="p">.</span><span class="n">sock</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">connections</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Peer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">peer_id</span><span class="si">}</span><span class="s"> closed connection with Peer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">other_peer_id</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ConnectionError</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Peer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">peer_id</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">other_peer_id</span><span class="si">}</span><span class="s"> connection was closed</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rcv</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
        <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">sock</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">28</span> <span class="k">if</span> <span class="n">raw</span> <span class="o">==</span> <span class="sa">b</span><span class="sh">'</span><span class="s">P2PF</span><span class="sh">'</span> <span class="k">else</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">length</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">sock</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Peer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">peer_id</span><span class="si">}</span><span class="s"> received </span><span class="si">{</span><span class="n">msg</span><span class="p">.</span><span class="nf">get_type</span><span class="p">()</span><span class="si">}</span><span class="s"> from Peer </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">other_peer_id</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</code></pre></div></div> <h4 id="respond">Respond</h4> <p>Because Python doesn’t have switch statements, we revert to using a large if statement. We compare the Message type field with the constants from the message module.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Connection</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">HANDSHAKE</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">other_peer_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">initiate_handshake</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">handshake</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">peer_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">has_file</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">bitfield</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">arr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">CHOKE</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">UNCHOKE</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_request_piece</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">INTERESTED</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">interested</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">NOT_INTERESTED</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">interested</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">HAVE</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">other_arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_notify_interest</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">BITFIELD</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">other_arr</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">other_arr</span><span class="p">.</span><span class="nf">frombytes</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_notify_interest</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">REQUEST</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">,</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">piece</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">pieces</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">message</span><span class="p">.</span><span class="n">PIECE</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="sh">'</span><span class="s">big</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">piece</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">pieces</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">piece</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">piece_size</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">piece</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">self</span><span class="p">.</span><span class="n">pieces_received</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">connections</span><span class="p">:</span>
                <span class="n">conn</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">have</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_request_piece</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_request_piece</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_notify_interest</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
</code></pre></div></div> <h3 id="startpeers-1">StartPeers</h3> <p>Instead of a main function, Python scripts are executed top to bottom. This holds even for imported files. So if we run <code class="language-plaintext highlighter-rouge">python A.py</code> which imports <code class="language-plaintext highlighter-rouge">B.py</code> , both containing</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</code></pre></div></div> <p>the output will be</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>B
__main__
</code></pre></div></div> <p>The script executing using the <code class="language-plaintext highlighter-rouge">python</code> command is given <code class="language-plaintext highlighter-rouge">__name__ = '__main__' </code>, which is what <a href="https://github.com/GeorgeRPu/BitTorrent-like/blob/main/python/start_peers.py" rel="external nofollow noopener" target="_blank">start_peers</a> is checking for.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="nc">Config</span><span class="p">(</span><span class="sh">"</span><span class="s">Common.cfg</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">PeerInfo.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">peer_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">.</span><span class="nf">readlines</span><span class="p">():</span>
            <span class="p">[</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">has_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
            <span class="n">peer_</span> <span class="o">=</span> <span class="n">peer</span><span class="p">.</span><span class="nc">Peer</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">peer_id</span><span class="p">),</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">has_file</span><span class="p">),</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">peer_info</span><span class="p">)</span>
            <span class="n">peer_</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
            <span class="n">peer_info</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</code></pre></div></div> <hr> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>Based on a sample size of 2 universities, attended by a friend and I. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>This is actually not necessary. We could store the file entirely on disk, reading/writing each time a piece is requested/received. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:3" role="doc-endnote"> <p>The last two variables are renamed to <code class="language-plaintext highlighter-rouge">toUnchoke</code> and <code class="language-plaintext highlighter-rouge">toChoke</code>. The shorter names are easier to visually distinguish. The differing word is shifted to the end from the middle. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:4" role="doc-endnote"> <p>This is actually what was intended for the Java implementation, but <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ProcessBuilder.html" rel="external nofollow noopener" target="_blank">ProcessBuilder</a> cannot run methods in new processes. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/crdt/">Conflict Free Replicated Data Types</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/books/">2022 in Books</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/research-code/">Writing Code for (Machine Learning) Research</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/floc/">Federated Learning of Cohorts</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/fl-fedavg/">Federated Learning: FedAvg (Part 1)</a> </li> <div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"GeorgeRPu/georgerpu.github.io","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 George Pu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@4.0.0-beta.3/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>